#!/bin/sh

# diff-s-sweet: Given two filenames
# (in s-expressions and sweet-expressions respectively),
# show the semantic differences between them.
# If there's a difference, show the difference and return an error code,
# else show nothing and return true (0).
# When given "-w" ("well-formatted"), check if it's well-formatted
# by running "unsweeten" and seeing if there's a semantic difference.

# (C) 2013 David A. Wheeler
# Released under the MIT license

# TODO: Add support for:
# -w Check if file list is set of well-formatted s-expressions
#    (if no files, stdin; support - as stdin)
# Document usage, etc. in man page

export PATH="@PATH_PREFIX@$PATH"
SWEETEN="sweeten"
UNSWEETEN="unsweeten"

if [ $# -ne 2 ] ; then
  echo "Usage: $0 s-expression-filename sweet-expression-filename"
  exit 99
fi
if [ ! -f "$1" ] ; then
  echo "File 1 (for s-expressions) must exist as a normal file"
  exit 98
fi
if [ ! -f "$2" ] ; then
  echo "File 2 (for sweet-expressions) must exist as a normal file"
  exit 98
fi


# Pretty print filter, from stdin to stdout.
prettyprint() {
guile -c '
  (use-modules (ice-9 pretty-print))
   (do ((x (read) (read)))
     ((eof-object? x))
   (pretty-print x))'
}

# The sed commands deletes ;-only lines; the awk command
# merges 2+ blank lines into one blank line.
# We don't ignore ALL blank lines, because blank lines can have an effect.
# For example, a blank line followed by an indent has
# a different meaning if we remove the blank line.
# All of this assumes that we're not using multi-line strings.

prettyprint < "$1" > ,first

${UNSWEETEN} "$2" | prettyprint > ,second

diff -u ,first ,second
